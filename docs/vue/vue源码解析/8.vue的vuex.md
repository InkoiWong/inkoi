# 八、vue 的 vuex

## 前言

按官网说法：“由于 Vuex 的状态存储是响应式的，从 store 实例中读取状态最简单的方法就是在计算属性中返回某个状态”

```js
import Vue from 'vue';
import Vuex from 'vuex';
Vue.use(Vuex);
const vueStore = new Vuex.Store({
  state: {
    count: 0
  },
  mutations: {
    increment(state) {
      state.count++;
    }
  }
});
let vm = new Vue({
  el: '#app',
  store: vueStore,
  template: '<div>{{count}}</div>',
  computed: {
    count() {
      return this.$store.state.count;
    }
  }
});
```

下面主要分析为什么可以通过 `this.$store` 直接访问 vueStore 对象。先看看 Vue.use 方法：

[](.\vue\src\core\global-api\use.js)

```js
Vue.use = function(plugin) {
  //插件只能注册一次
  var installedPlugins =
    this._installedPlugins || (this._installedPlugins = []);
  if (installedPlugins.indexOf(plugin) > -1) {
    return this;
  }

  //拼接参数，将Vue作为第一个参数
  // additional parameters
  var args = toArray(arguments, 1);
  args.unshift(this);

  //调用plugin.install或plugin方法
  if (typeof plugin.install === 'function') {
    plugin.install.apply(plugin, args);
  } else if (typeof plugin === 'function') {
    plugin.apply(null, args);
  }
  installedPlugins.push(plugin);
  return this;
};
```

再看 Vuex 源码，Vuex 其实是下面这个对象

[](./vuex/src/index.js)

```js
{
  Store: Store,
  install: install,
  mapState: mapState,
  mapMutations: mapMutations,
  mapGetters: mapGetters,
  mapActions: mapActions,
  createNamespacedHelpers: createNamespacedHelpers
}
```

因此 Vue.use(Vuex)其实想到于 Vuex.install()

[](.\vuex\src\store.js)
[](.\vuex\src\mixin.js)

```js
let Vue; // bind on install
function install(_Vue) {
  Vue = _Vue;
  applyMixin(Vue);
}

var applyMixin = function(Vue) {
  var version = Number(Vue.version.split('.')[0]);
  //Vue2.0处理方法
  if (version >= 2) {
    //将vuexInit方法注册到beforeCreate钩子上，当Vue的生命周期走到callHook(vm, 'beforeCreate');时触发vuexInit方法
    Vue.mixin({ beforeCreate: vuexInit });
  }

  // Vuex init hook, injected into each instances init hooks list.
  function vuexInit() {
    //this就是当前正在被new的Vue对象
    var options = this.$options;
    //将options.store（本例demo中的vueStore）赋值给this.$store，因此可以通过this.$store访问vueStore对象
    // store injection
    if (options.store) {
      this.$store =
        typeof options.store === 'function' ? options.store() : options.store;
    } else if (options.parent && options.parent.$store) {
      this.$store = options.parent.$store;
    }
  }
};
```
